<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Items | Admin</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.1.0/css/all.css">
    <style>
        body { background: transparent; padding: 0; margin: 0; overflow-x: hidden; }
        .admin-layout { min-height: auto; background: transparent; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.3);
        }
        body.dark-theme ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        body.dark-theme ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
        }

        /* Add Button Style */
        .btn-add {
            background: var(--brand-accent);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn-add:hover {
            background: var(--brand-primary-dark, #2563eb);
        }

        /* Dark Mode Specifics */
        body.dark-theme .btn-add {
            background: var(--brand-accent);
            color: white;
        }
        
        body.dark-theme .modal-container {
            background: var(--surface-card);
            border: 1px solid rgba(255,255,255,0.1);
        }

        body.dark-theme input, body.dark-theme select {
            background: var(--surface-bg);
            color: var(--text-primary);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        body.dark-theme input:focus, body.dark-theme select:focus {
            border-color: var(--brand-accent);
        }
    </style>
</head>
<body>
    <script>
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-theme');
        }
    </script>
    <div class="page-header">
        <div class="page-title">
            <h1>Manage Items</h1>
            <p>Add, edit, or remove items from the database.</p>
        </div>
        <button class="btn-add" onclick="openAddModal()">
            <i class="fas fa-plus"></i> Add New Item
        </button>
    </div>

    <div class="card">
        <div style="margin-bottom: 1rem; display: flex; gap: 1rem;">
            <div class="header-search" style="width: 100%; max-width: 300px;">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search items..." onkeyup="filterItems()">
            </div>
            <select id="categoryFilter" onchange="filterItems()" style="padding: 0 1rem; border-radius: var(--radius-full); border: 1px solid rgba(0,0,0,0.1); background: var(--surface-bg); color: var(--text-primary);">
                <option value="">All Categories</option>
                <option value="Vegetables">Vegetables</option>
                <option value="Fruits">Fruits</option>
                <option value="Grains">Grains</option>
            </select>
        </div>

        <table class="data-table">
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Category</th>
                    <th>Unit</th>
                    <th>Price</th>
                    <th>Views</th>
                    <th>Status</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be loaded here -->
            </tbody>
        </table>
    </div>

    <!-- Add Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal-container">
            <div class="modal-header">
                <h2>Add New Item</h2>
                <button class="close-modal" onclick="closeModal('addModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="addForm" onsubmit="event.preventDefault(); saveNewItem();">
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" id="addName" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <input type="text" id="addCategory" placeholder="Vegetables, Fruits, etc." required>
                    </div>
                    <div class="form-group">
                        <label>Price</label>
                        <input type="number" id="addPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Unit</label>
                        <input type="text" id="addUnit" placeholder="kg, dozen, etc." required>
                    </div>
                    <div class="form-group">
                        <label>Icon Class (FontAwesome)</label>
                        <input type="text" id="addIcon" placeholder="fa-carrot" value="fa-box">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="addStatus">
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('addModal')">Cancel</button>
                <button class="btn-submit" style="width: auto; padding: 0.6rem 1.5rem;" onclick="saveNewItem()">Add Item</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-container">
            <div class="modal-header">
                <h2>Edit Item</h2>
                <button class="close-modal" onclick="closeModal('editModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="editForm" onsubmit="event.preventDefault(); saveChanges();">
                    <input type="hidden" id="editId">
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" id="editName" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <input type="text" id="editCategory" required>
                    </div>
                    <div class="form-group">
                        <label>Price</label>
                        <input type="number" id="editPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Unit</label>
                        <input type="text" id="editUnit" required>
                    </div>
                    <div class="form-group">
                        <label>Icon Class</label>
                        <input type="text" id="editIcon">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="editStatus">
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('editModal')">Cancel</button>
                <button class="btn-submit" style="width: auto; padding: 0.6rem 1.5rem;" onclick="saveChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-container" style="max-width: 400px;">
            <div class="modal-header">
                <h2 style="color: var(--brand-danger);">Confirm Deletion</h2>
                <button class="close-modal" onclick="closeModal('deleteModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    Are you sure you want to remove <strong id="deleteItemName" style="color: var(--text-primary);">Item</strong>?
                </p>
                <p style="font-size: 0.85rem; color: var(--brand-danger); background: rgba(239, 68, 68, 0.1); padding: 0.75rem; border-radius: var(--radius-sm);">
                    <i class="fas fa-exclamation-triangle"></i> This action cannot be undone.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
                <button class="btn-submit" style="width: auto; padding: 0.6rem 1.5rem; background: var(--brand-danger);" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        let allItems = [];

        document.addEventListener('DOMContentLoaded', loadItems);

        function loadItems() {
            fetch('../API/admin/getItems.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allItems = data.data;
                        renderItems(allItems);
                    } else {
                        if (data.redirect) {
                            window.top.location.href = data.redirect;
                        } else {
                            console.error('Failed to load items:', data.message);
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function renderItems(items) {
            const tbody = document.querySelector('.data-table tbody');
            tbody.innerHTML = '';
            items.forEach(item => {
                let statusClass = 'status-info';
                if(item.status === 'active') statusClass = 'status-success';
                if(item.status === 'rejected') statusClass = 'status-danger';
                if(item.status === 'pending') statusClass = 'status-warning';

                const row = `
                    <tr>
                        <td style="font-weight: 500;">
                            <i class="fas ${item.icon || 'fa-box'}" style="margin-right: 0.5rem; color: var(--text-tertiary);"></i>
                            ${item.name}
                        </td>
                        <td>${item.category}</td>
                        <td>${item.unit}</td>
                        <td>Rs. ${item.price}</td>
                        <td>${item.views || 0}</td>
                        <td><span class="status-badge ${statusClass}">${item.status}</span></td>
                        <td>${item.last_updated || 'N/A'}</td>
                        <td>
                            <button class="action-btn edit" onclick="openEditModal(${item.id})"><i class="fas fa-pen"></i></button>
                            <button class="action-btn delete" onclick="openDeleteModal(${item.id}, '${item.name}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function filterItems() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;

            const filtered = allItems.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm);
                const matchesCategory = categoryFilter === '' || item.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            renderItems(filtered);
        }

        // Modal Functions
        function openAddModal() {
            document.getElementById('addForm').reset();
            const modal = document.getElementById('addModal');
            modal.classList.add('active');
        }

        function openEditModal(id) {
            const item = allItems.find(i => i.id == id);
            if(!item) return;

            document.getElementById('editId').value = item.id;
            document.getElementById('editName').value = item.name;
            document.getElementById('editCategory').value = item.category;
            document.getElementById('editPrice').value = item.price;
            document.getElementById('editUnit').value = item.unit;
            document.getElementById('editIcon').value = item.icon;
            document.getElementById('editStatus').value = item.status;
            
            const modal = document.getElementById('editModal');
            modal.classList.add('active');
        }

        let itemToDeleteId = null;
        function openDeleteModal(id, name) {
            itemToDeleteId = id;
            document.getElementById('deleteItemName').textContent = name;
            const modal = document.getElementById('deleteModal');
            modal.classList.add('active');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
        }

        function saveNewItem() {
            const name = document.getElementById('addName').value;
            const category = document.getElementById('addCategory').value;
            const price = document.getElementById('addPrice').value;
            const unit = document.getElementById('addUnit').value;
            const icon = document.getElementById('addIcon').value;
            const status = document.getElementById('addStatus').value;

            fetch('../API/admin/addItem.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, category, price, unit, icon, status }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Item added successfully');
                    closeModal('addModal');
                    loadItems();
                } else {
                    alert('Failed to add: ' + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function saveChanges() {
            const id = document.getElementById('editId').value;
            const name = document.getElementById('editName').value;
            const category = document.getElementById('editCategory').value;
            const price = document.getElementById('editPrice').value;
            const unit = document.getElementById('editUnit').value;
            const icon = document.getElementById('editIcon').value;
            const status = document.getElementById('editStatus').value;

            fetch('../API/admin/updateItem.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, name, category, price, unit, icon, status }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Item updated successfully');
                    closeModal('editModal');
                    loadItems();
                } else {
                    alert('Failed to update: ' + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function confirmDelete() {
            if (!itemToDeleteId) return;

            fetch('../API/admin/deleteItem.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: itemToDeleteId }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Item deleted successfully');
                    closeModal('deleteModal');
                    loadItems();
                } else {
                    alert('Failed to delete: ' + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>